<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://fonts.googleapis.com/css2?family=Fjalla+One&family=Manrope:wght@200&display=swap" rel="stylesheet">
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRB</title>
    <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Manrope,sans-serif;background:linear-gradient(135deg,#ece9e6,#fff);display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}.main{display:flex;justify-content:center;align-items:center}.box{width:350px;background:#f9f9f9;border:2px solid #ddd;border-radius:15px;padding:20px;box-shadow:0 4px 8px #0000001a}.box p{font-size:20px;text-align:center;font-family:Fjalla One,sans-serif;margin-bottom:10px}#txt{font-size:12px;text-align:justify;margin-bottom:20px;color:#555}.xyz{border:1px solid #ddd;border-radius:8px;width:100%;height:40px;margin-bottom:15px;font-size:14px;padding:5px 10px;background:#fff;transition:border-color .3s ease}.xyz:focus{border-color:#4a90e2;outline:none}::placeholder{font-size:14px;color:#999}.yu1{text-decoration:none;border:none;padding:12px 20px;width:100%;text-align:center;text-transform:uppercase;background-color:#4a90e2;color:#fff;font-family:Arial,sans-serif;font-weight:700;border-radius:8px;cursor:pointer;transition:background-color .3s ease}.yu1:hover{background-color:#357abd}.checkbox-label{display:flex;align-items:center;margin-bottom:15px}.checkbox-label input{margin-right:10px}
</style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
    
function countSyllables(word) {
    if (word.length <= 3) return 1;
    word = word.toLowerCase();
    const matches = word.match(/[aeiouy]{1,2}/g);
    let syllables = matches ? matches.length : 1;
    if ((word.endsWith("es") && !word.endsWith("sses")) ||
        (word.endsWith("ed") && !word.endsWith("lled")) ||
        (word.endsWith("e") && !'aeiouy'.includes(word[word.length-2]))) {
        syllables--;
    }
    return Math.max(1, syllables);
}

function fleschKincaidReadability(text) {
    const sentences = text.split(/[.!?]/).filter(sentence => sentence.trim() !== '');
    const words = text.split(/[^a-zA-Z]+/);
    var syllables = 0;
    for (let word of words) {
        syllables += countSyllables(word);
    }
    const gradeLevel = 0.39 * (words.length / sentences.length) + 11.8 * (syllables / words.length) - 15.59;
    return gradeLevel < 1 ? 'Kindergarten' : 
           gradeLevel > 16 ? 'Post-graduate' : 
           gradeLevel > 12 ? 'College' : 
           Math.floor(gradeLevel) + '-' + Math.ceil(gradeLevel) + ' grade';
}

async function generatePDF() {
    import { PDFDocument } from 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js';
    const { jsPDF } = window.jspdf;

    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const contact = document.getElementById('contact').value;
    const query = document.getElementById('query').value;
    const notRobot = document.getElementById('notRobot').checked;
    const fileInput = document.getElementById('fileUpload');

    if (!notRobot) {
        alert('Please confirm you are not a robot.');
        return;
    }

    if (fileInput.files.length === 0) {
        alert('Please select at least one file to upload.');
        return;
    }

    try {
        const mergedPdf = await PDFDocument.create();

        const formDoc = new jsPDF();
        formDoc.setFontSize(16);
        formDoc.text("IRB Submission Form", 20, 20);
        formDoc.setFontSize(12);
        formDoc.text(`Name: ${name}`, 20, 40);
        formDoc.text(`Email: ${email}`, 20, 50);
        formDoc.text(`Contact: ${contact}`, 20, 60);
        formDoc.text(`Query: ${query}`, 20, 70);

        const formPdfBytes = formDoc.output('arraybuffer');
        const formPdfDoc = await PDFDocument.load(formPdfBytes);
        const formPages = await mergedPdf.copyPages(formPdfDoc, formPdfDoc.getPageIndices());
        formPages.forEach(page => mergedPdf.addPage(page));

        let allText = `${name} ${email} ${contact} ${query} `;

        for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            const fileType = file.type.toLowerCase();

            if (fileType.includes('image')) {
                const imageBytes = await file.arrayBuffer();
                let image;
                
                if (fileType.includes('png')) {
                    image = await mergedPdf.embedPng(imageBytes);
                } else if (fileType.includes('jpeg') || fileType.includes('jpg')) {
                    image = await mergedPdf.embedJpg(imageBytes);
                } else {
                    console.warn(`Unsupported image type: ${fileType}`);
                    continue;
                }

                const imagePage = mergedPdf.addPage();
                const { width, height } = image.size();
                const pageWidth = imagePage.getSize().width;
                const pageHeight = imagePage.getSize().height;
                
                const scale = Math.min(
                    pageWidth / width,
                    pageHeight / height
                );

                imagePage.drawImage(image, {
                    x: (pageWidth - width * scale) / 2,
                    y: (pageHeight - height * scale) / 2,
                    width: width * scale,
                    height: height * scale
                });
            } else if (fileType.includes('pdf')) {
                const uploadedPdfBytes = await file.arrayBuffer();
                const uploadedPdfDoc = await PDFDocument.load(uploadedPdfBytes);
                const uploadedPages = await mergedPdf.copyPages(uploadedPdfDoc, uploadedPdfDoc.getPageIndices());
                uploadedPages.forEach(page => mergedPdf.addPage(page));
                
                //const pdfText = await extractTextFromPDF(uploadedPdfDoc);
                //allText += pdfText + ' ';

            } else if (fileType.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) {
                const noticePage = mergedPdf.addPage();
                const { helvetica } = await mergedPdf.embedFont(PDFDocument.Standard.Helvetica);
                noticePage.drawText('Word document attached: ' + file.name, {
                    x: 50,
                    y: noticePage.getSize().height - 100,
                    size: 12,
                    font: helvetica
                });

                const arrayBuffer = await file.arrayBuffer();
                //const wordText = await extractTextFromWord(arrayBuffer);
                allText += wordText + ' ';
                
                const wordBlob = new Blob([await file.arrayBuffer()], { type: fileType });
                const wordUrl = URL.createObjectURL(wordBlob);
                const wordLink = document.createElement('a');
                wordLink.href = wordUrl;
                wordLink.download = 'original-' + file.name;
                document.body.appendChild(wordLink);
                wordLink.click();
                document.body.removeChild(wordLink);
                URL.revokeObjectURL(wordUrl);
            }
        }

        // const readingLevel = fleschKincaidReadability(allText);

        
        // const lastPage = mergedPdf.addPage();
        // const { helvetica } = await mergedPdf.embedFont(PDFDocument.Standard.Helvetica);
        // lastPage.drawText(`Document Reading Level: ${readingLevel}`, {
        //     x: 50,
        //     y: lastPage.getSize().height - 50,
        //     size: 12,
        //     font: helvetica
        // });

        const mergedPdfBytes = await mergedPdf.save();
        const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'submission-package.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

    } catch (error) {
        console.error('Error processing files:', error);
        alert('Error processing files. Please try again.');
    }
}

// async function extractTextFromPDF(pdfBytes) {
//     const pdfjsLib = await import('pdfjs-dist/webpack');
//     const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
//     const pdf = await loadingTask.promise;

//     let text = '';
//     for (let i = 1; i <= pdf.numPages; i++) {
//         const page = await pdf.getPage(i);
//         const content = await page.getTextContent();
//         text += content.items.map(item => item.str).join(' ') + ' ';
//     }
//     return text;
// }

async function extractTextFromWord(arrayBuffer) {
    try {
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        return result.value || '';
    } catch (error) {
        console.error('Error extracting text from Word document:', error);
        return '';
    }
}

function handleFileSubmission(event) {
    event.preventDefault();
    generatePDF();
}

window.handleFileSubmission = handleFileSubmission;   


    </script>
  <script type="module" crossorigin src="/assets/index-r6uqEuif.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-yuL8yfv0.css">
</head>
<body>
    <div class="main">
        <div class="box">
            <p>Institutional Review Board Protocol Form</p> 
            <p id="txt">Thank you for submitting your application to the IRB for consideration. Depending on the level of the
                review, the IRB members will take between 2 and 4 weeks to consider your application. Prior to submitting
                please make sure that your application is
                1. Complete and contains all necessary elements
                2. Is proofread and error-free (we recommend that you complete it in a separate document and then
                copy/paste the required sections into this form)
                3. Contains all necessary attachments.
                Please be advised that incomplete applications will be returned thus delaying the review/approvals.
                If you have any questions or need to discuss your application, please email to irb@caldwell.edu
                </p>
            <form method="POST">
                <!-- Added id attributes -->
                <input type="text" id="name" placeholder="Name" class="xyz" required>  
                <input type="email" id="email" placeholder="Email Address" class="xyz" required>  
                <input type="text" id="contact" placeholder="Contact" class="xyz" required>  
                <input type="text" id="query" placeholder="Department" class="xyz" required>  
                
                <br><br>
                
                <input type="file" id="fileUpload" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="xyz" required multiple>
                
                <div class="checkbox-label">
                    <input type="checkbox" id="notRobot" required>
                    <span>I'm not a robot</span>
                </div> <br>
                
                <button type="button" class="yu1" onclick="generatePDF()">Download PDF</button> 

                <br><br>

                
            </form>
        </div>
    </div> 
</body> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</html>
